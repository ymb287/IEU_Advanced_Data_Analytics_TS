---
title: "Advanced Data Analytics"
author:
  - Loukas Gonzalez
  - Simon Alvarez Bliffeld
  - Simon Gonzalez
  - Yannik Biebert
date: "2023-11-28"
output:      
  rmarkdown::html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
# Set up: do not change!!!
knitr::opts_chunk$set(echo = TRUE)
```

<br>

------------------------------------------------------------------------

<br>

For the final project of Advanced Data Analytics, we decided to analyze three variables of two different countries, and with them, find and dissect valuable information, with which we can after create forecasts. The two countries that we decided on were Italy and the US, two countries that despite their distinct economic landscapes, share a profound impact on the global stage. The variables that we will be using will be the country's GDP, which is one of the most crucial indicators of the overall growth of the country, the CPI or Consumer Price Index, which goes along with the GDP but also gives us further information, and the Stock Market Index for each country.

# Part 1: Prepare and inspect the data

-   Visual inspection of data and season, trend DONE, including desriptions

-   Stationarity testing DONE

-   Inspect autocorrelation with acf and pacf DONE

Steps for us:

-   Inspect volatility clustering (if so, maybe GARCH needed?) DONE

-   if it has season use holt-winters, DO WE NEED TBATS or STLM? Because I dont think whe have two cicles in each other # DONE

-   Look for ARIMA models (on data and on estimated ets()/msts()

-   Identify the regular component by exploring the ACF and PACF of the residuals of the seasonal model.

-   Compare models (including ets models)- AIC or Accuracy Metrics

-   Choose best model and visualize, look at residuals, maybe GARCH (or should be aready dicide this before using ARIMA Model and use it directly?)

-   Use maybe Garch, and compare those models

-   Summary of findings

-   Forcast and plot final model

-   conclusion of forecast

------------------------------------------------------------------------

## 1.1 Importing and inspecting the data set

```{r Import data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# import packages
library(pacman)
p_load(
  readxl, tseries, tidyverse, dplyr, tidyr, forecast, fpp2, stats, quantmod, zoo, lubridate, ggplot2, cowplot, rugarch
)

# import data set xlxs
data <- read_excel("Datasets.xlsx")

# removing not used columns Housing and Unemployment
data <- data[, -c(7, 9)]


# Display the data set
print(data)

```

As observed, the years that we will be using for this analysis are from 2000 to 2020, giving us a comprehensive analysis of each country's variables throughout the 21st century.

## 1.2 Prepare the data

```{r transform data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Split the data into two dataframes based on the country
data_italy <- subset(data, Country %in% c("Italy"))
data_usa <- subset(data, Country %in% c("USA"))

# Function for data transformation
transform_data <- function(df) {
  # Extract columns from the dataframe
  gdp <- df$'GDP, billion currency units'
  cpi <- df$'Consumer Price Index (CPI)'
  stocks <- df$'Stock market index'

  # Drop missing values (becuase only every quarter)
  gdp <- na.omit(gdp)

  # Drop missing values (becuase last in the month)
  cpi <- na.omit(cpi)
  stocks <- na.omit(stocks)

  # Change to time series
  gdp <- ts(gdp, start = c(2000, 1), frequency = 4)
  cpi <- ts(cpi, start = c(2000, 1), frequency = 12)
  stocks <- ts(stocks, start = c(2000, 1), frequency = 12)
  
  # Drop everything after 2019
  gdp <- window(gdp, end = c(2019, 4))
  cpi <- window(cpi, end = c(2019, 12))
  stocks <- window(stocks, end = c(2019, 12))
  
  # Return the time series as separate variables
  return(list(gdp = gdp, cpi = cpi, stocks = stocks))
}

# Apply the transformation function
transformed_italy  <- transform_data(data_italy)
transformed_usa <- transform_data(data_usa)

```

After analyzing the data, we decided to omit the information from 2020 onwards. The Covid pandemic in 2020 significantly disrupted global economic patterns, causing unprecedented fluctuations in GDP, CPI, and Stock Market Indices. The widespread lockdowns, supply chain disruptions, and shifts in consumer behavior during the pandemic created outliers in the data that could skew our analysis and adversely affect the accuracy of our forecasts.

## 1.3 Visual inspection of the data, including Seasonality

```{r plot gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Create a function for visualization.
plot_and_zoom <- function(data, variable, country,num_years) {
  
  # Extract the specified number of years from the time series
  end_date <- start(data) + c(num_years, 0)
  window_data <- window(data, start = start(data), end = end_date)
  
  # Create the main plot
  main_plot <- ggplot(data, aes(x = time(data), y = as.numeric(data))) +
    geom_line() +
    theme_minimal() +
    labs(title = paste0(variable, ' in ', country), x = "Year", y = variable) +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5))
  
  # Create a zoomed-in version with the specified number of years
  zoomed_in_plot <- ggplot(window_data, aes(x = time(window_data), y = as.numeric(window_data))) +
    geom_line() +
    labs(title = paste0('Zoomed in ',variable, ' in ', country), x = "Year", y = variable) +
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5))
  
  plot_grid(main_plot, zoomed_in_plot, ncol = 1)
  
}

# Plot the GDP for Italy
plot_and_zoom(transformed_italy$gdp, 'GDP', 'Italy', 4)

```

We can make some observations by looking at the graph of Italy's GDP from 2000 - 2020. The GDP shows a clear upward trend, with a sharper increase from 2000 to 2008, where it stabilizes, and again an increase from 2015-2020. The interruption in the trend corresponds to the 2008 financial crisis, which shook the economy and its growth. We can also note a seasonality throughout the time series. Italy's economy after 2001 began to slow down, even though the GDP is seen to be growing, the rate of growth had decreased. Factors such as "aging population, inflation, stagnation, and the impact of globalization on trade and demand" heavily affected the country's development and economic growth (Ardeni & Gallegati, 2023). Italy's development is slow mainly when compared to other countries European countries with similar capabilities and factors. We can observe another factor in the zoomed version of Italy's GDP. The plot shows a clear trend or pattern of seasonality, wherein in the first part of the year we observe a slight increase in the GDP, followed by a sharper increase in the second part of the year, and this is observed in all of the years included. This could be attributed to factors such as traditional vacation patterns, tourism peaks, or specific industry behaviors.

```{r plot cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the CPI for Italy
plot_and_zoom(transformed_italy$cpi, 'CPI', 'Italy', 4)


```

Italy's CPI has seen a similar path to the GDP. From 2000 onwards, Italy's Consumer Price Index (CPI) has undergone fluctuations influenced by various economic factors. In the early 2000s, the CPI experienced constant growth, which continued until 2012, when it began to slow down and reduce the growth rate. This might be the consequence on the financial crisis, combined with internal economic and political issues. The zoomed plot also reveals seasonality, as we can observe dips in the CPI in the first part of each year for all of the observed periods. This could be attributed to high spending seasons of the year, as it usually is found in most CPI plots, such as holidays.

```{r plot stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot stocks for Italy
plot_and_zoom(transformed_italy$stocks, 'Stocks', 'Italy', 4)

```

The Stock Market Index for Italy is very different from the previous charts and datasets. As observed, the market had many fluctuations throughout the 2000 - 2020 period. We can observe that from 2000 to 2003, Italy's stock market had a steep decline, followed by a rapid growth period that was again stopped by the financial crisis of 2008-2009. The index maintained high volatility for the following period, with short periods of growth or decline, but with an overall positive growth trend. Again, most of the behavior of the market is related to political decisions that the Italian government has made and external economic factors influencing investor confidence. Notably, the stock market showed increased volatility during times of political unpredictability or changes in governmental policy. Furthermore, the overall state of the world economy, particularly the Eurozone crisis, had a big impact on how the Italian stock market developed (Codogno & Galli, 2022).

```{r plot gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot GDP for USA
plot_and_zoom(transformed_usa$gdp, 'GDP', 'USA', 4)

```

In the United States GDP time series, we again observe a positive trend, with periods of faster increase. There is a specific moment where we see an interruption in the growth, which is in 2008, corresponding to the Financial Crisis. After this period, we can observe that the GDP grew at a faster rate. Aiming to revive the economy, major government interventions, fiscal stimulus packages, and monetary policies are responsible for these accelerations in GDP growth in the post-crisis decades. The United States has gained more and more power and importance globally, which again also influenced the constant growth of its GDP (Salvatore, 2020). No indications of seasonality or a specific pattern can be observed in the plot or the zoomed plot. Moreover, it can be observed that the GDP for USA is significantly higher than Italy's, mostly as a result of the US doing more business abroad and having a bigger economy. The USA's economy is stronger than Italy's due in part to their larger corporations, advancements in technology, and international trading practices.

```{r plot cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot CPI for USA
plot_and_zoom(transformed_usa$cpi, 'CPI', 'USA', 4)

```

The USA's CPI follows a very positive trend, with continuous growth throughout the period observed. We can observe certain moments of slowdown, specifically after the 2008 financial crisis, but even with this, the CPI is constantly growing, at a somewhat slow rate. No seasonality or specific pattern can be observed in the plot or the zoomed plot. This upward trend points to an economy that is typically growing and stable, with rare setbacks like the financial crisis eventually being resolved. These variations in the growth rate could also be a sign of the economy's resiliency and capacity to bounce back from setbacks, which would explain the CPI's general upward tendency.

```{r plot stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot stocks for USA
plot_and_zoom(transformed_usa$stocks, 'Stocks', 'USA', 4)

```

The Stock Market index for the USA different from what we observed in Italy, shows a clear upward trend, with some periods of higher volatility and shifts. Again, as noted in all of the previous plots, we see a period of decline right in 2008, which corresponds to the financial crisis, where gains were lost in a very short period. The U.S. stock market proved strong after this trying time, rising and showing a steady growth trend, confirming the economy's capacity to come back from difficult periods. The U.S. financial system's inherent flexibility and the proactive actions of policymakers are frequently credited for this recovery.

## 1.4 Train test split

```{r train test split alternative, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Function for train test split
train_test_split <- function(data_list, train_percentage = 0.8) {
  split_data <- list()
  
  # Loop through the variables in the list
  for (variable in names(data_list)) {
    ts_data <- data_list[[variable]]
    data_length <- length(ts_data)

    # Calculate the train size
    train_size <- round(train_percentage * data_length)
    
    # Train split, this way needed, to keep the ts format
    train_data <- ts(ts_data[1:train_size], start = start(ts_data), frequency = frequency(ts_data))

    end_time <- time(train_data)[length(train_data)]
    
    # Get start for testdata, if only split with [:] the ts type is lost as well as the start time
    if (frequency(ts_data) == 12) {
      end_time <- end_time + 1/12
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 12 + 1
    } else if (frequency(ts_data) == 4) {
      end_time <- end_time + 1/4
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 4 + 1
    } else {
      print('Error: Frequency not supported')
    }

    test_data <- ts(ts_data[(train_size + 1):data_length], start = c(start_year, start_month), frequency = frequency(ts_data))
    
    # Add the data to the list
    split_data[[paste0(variable, "_train")]] <- train_data
    split_data[[paste0(variable, "_test")]] <- test_data
  }

  return(split_data)
}

# Apply the train test split function
split_italy <- train_test_split(transformed_italy)
split_usa <- train_test_split(transformed_usa)

```

Splitting the data into a train and a test part is important to evaluate the models. By only splitting with [:] the ts type is lost as well as the start time. Therefore the function above is needed.

```{r extract data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Italy variables
gdp_italy_train <- split_italy$gdp_train
gdp_italy_test <- split_italy$gdp_test

cpi_italy_train <- split_italy$cpi_train
cpi_italy_test <- split_italy$cpi_test

stocks_italy_train <- split_italy$stocks_train
stocks_italy_test <- split_italy$stocks_test

# USA variables
gdp_usa_train <- split_usa$gdp_train
gdp_usa_test <- split_usa$gdp_test

cpi_usa_train <- split_usa$cpi_train
cpi_usa_test <- split_usa$cpi_test

stocks_usa_train <- split_usa$stocks_train
stocks_usa_test <- split_usa$stocks_test

```

The different variables are extracted from the list. Those variables are used for the model fitting.

## 1.5 Evaluate the data from Italy

```{r evaluate gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Analyse the different variables for stationarity
analyze_time_series <- function(ts_data, country, variable) {

  # Doing the ADF and PP test, as well as determining diff
  adf_result <- tseries::adf.test(ts_data)
  num_diffs <- ndiffs(ts_data)

  # Print results for the current variable
  cat("Results for", variable, "in", country, ":\n")
  cat("ADF Test:\n")
  cat("  P-Value:", adf_result$p.value, "\n")
  cat("Number of Differences Required for Stationarity:", num_diffs, "\n\n")
  
  # Set up the plot
  par(mfrow = c(1, 2), mar = c(3, 4, 4, 1))

  # ACF and PACF plots
  acf(ts_data, main = paste("ACF of", variable, "in", country))
  pacf(ts_data, main = paste("PACF of", variable, "in", country))
}

# Explore gdp of Italy
analyze_time_series(gdp_italy_train, "Italy", 'GDP')

```

In our financial analysis of Italy's GDP, the Autocorrelation Function (ACF) displayed over 15 significant lags, as well as the before seen seasonal pattern. Due to the slow decline we might conclude that it is an AR model. This is further supported due to the steep decline in the Partial Autocorrelation Function (PACF) after the fifth lag. Also the Model will probably include a seasonal component. Since is is quarterly and could already be seen in the plotted data. This might even reduce the PACF lags to 1. The Augmented Dickey-Fuller (ADF) test has a p-value of 0.83, which is more than 0.05, indicating that the data is non-stationary. The number of differences required for stationarity is 1.

```{r differenced gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Analyse the differenced variables for stationary
analyze_diff_series <- function(ts_data, country, variable, seasonal = 0) {
  
  # Getting number of differences required for stationarity
  num_diffs <- ndiffs(ts_data)
  
  # Differncing num_diffs times
  for (i in 1:num_diffs) {
    ts_data <- diff(ts_data)
  }
  
  if (seasonal != 0){
    ts_data <- diff(ts_data, lag = seasonal)
  }
  
  # Performing the ADF and PP test
  adf_result <- tseries::adf.test(ts_data)
  num_diffs_new <- ndiffs(ts_data)
  
  # Print results for the current variable
  cat("Results for", variable, "in", country, "with season", seasonal, ":\n")
  cat("ADF Test:\n")
  cat("  P-Value:", adf_result$p.value, "\n")
  cat("Number of Differences Required for Stationarity:", num_diffs_new, "\n\n")

}

# Difference data from Italy
analyze_diff_series(gdp_italy_train, "Italy", 'GDP')
analyze_diff_series(gdp_italy_train, "Italy", 'GDP', 4)

```

After using the recommended number of differences of 1 on Italy's GDP the Augmented Dickey-Fuller (ADF) test suggested marginal evidence against stationarity with a p-value of 0.062, as well as no further differencing. Since this is not completely stationary the 4th difference is take, because a seasonal component was detected in the ploted data as well as the ACF and PACF. In the seasonal scenario, the ADF test provided strong evidence for stationarity with a p-value of 0.01. This suggests to use one difference in the modeling part, as well as including a SAR.

```{r evaluate cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore cpi of Italy
analyze_time_series(cpi_italy_train, "Italy", 'CPI')

```

For Italy's CPI the ADF has a p-value of 0.95 suggesting evidence against stationarity. Also it is recommended to difference once. The ACF shows a slow decline and since the PACF has a steep drop at lag 1, as well as violations as 7 and 13, the model will probably have a bit focus on the AR part.

```{r differenced cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore cpi of Italy
analyze_diff_series(cpi_italy_train, "Italy", 'CPI')

```

After using the recommended number of differences (1) on Italy's CPI the Augmented Dickey-Fuller (ADF) test suggested  stationarity, as well as no further differencing.

```{r evaluate stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore stocks of Italy
analyze_time_series(transformed_italy$stocks, "Italy", 'Stocks')


```

For Italy's stock data the ADF has a p-value of 0.41 suggesting nn-stationarity. Also it is recommended to difference once. The ACF shows a slow decline and since the PACF has a steep drop at lag 2, the model will probably be an AR(2). This will be tested in the modeling part.


```{r differenced stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore stocks of Italy
analyze_diff_series(stocks_italy_train, "Italy", 'Stocks')

```

After using the recommended number of differences (1) on Italy's stock data the Augmented Dickey-Fuller (ADF) test suggested stationarity, as well as no further differencing is recommended. 

```{r evaluate gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore gdp of USA
analyze_time_series(transformed_usa$gdp, "USA", 'GDP')

```

For USA GDP data the ADF test suggested with a p-value of 0.82 non-stationarity. Also taking one difference is recommended. The ACF shows a slow decline and since the PACF has a steep drop at lag 1, the model will probably be an AR(1). This will be tested in the modeling part.

```{r differenced gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore gdp of Italy
analyze_diff_series(gdp_usa_train, "USA", 'GDP')
analyze_diff_series(diff(gdp_usa_train), "USA", 'GDP')

```

After using the recommended number of differences (1) on USA GDP the Augmented Dickey-Fuller (ADF) test suggested evidence against stationarity with a p- value of 0.29, as well as no further differencing. Since this is not completely stationary it was differenced once more and then the ADF test provided strong evidence for stationarity. This suggests using one difference in the modeling part, and inlcuding a drift.

```{r evaluate cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore cpi of USA
analyze_time_series(cpi_usa_train, "USA", 'CPI')

```

For USA cpi data the ADF test has a p-value of 0. 0.89 suggesting non-stationarity. Also taking one difference is recommended. The ACF shows a slow decline and since the PACF has a steep drop at lag 1, the model will probably be an AR(1). This will be tested in the modeling part.

```{r differenced cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore cpi of Italy
analyze_diff_series(cpi_usa_train, "USA", 'CPI')

```

After using the recommended number of differences on USA cpi the Augmented Dickey-Fuller (ADF) test rejects the H0 hypothesis, and suggests stationary. This suggests using one difference in the modeling part.

```{r evaluate stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore stocks of USA
analyze_time_series(stocks_usa_train, "USA", 'Stocks')

```

For USA stock data the Augmented Dickey-Fuller test has a p-value of 0.  0.41. The ACF shows a slow decline and  the PACF has a steep drop at lag 1 and a violation at lag 2.

```{r differenced stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore stocks of Italy
analyze_diff_series(stocks_usa_train, "USA", 'Stocks')

```

After using the recommended number of differences on USA stock the Augmented Dickey-Fuller test suggests stationarity. Also no further differencing is recommended.

## 1.5 Volatility clustering

QUESTION? Is that it?

```{r volatility clustering italy stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

plot_volatility_clusters <- function(time_series, country, variable, uper = 0) {
  
  # Calculate the squared returns
  time_series <- diff(time_series)^2
  
  if (uper == 0) {
    uper <- max(time_series) + max(time_series)*0.05
  }

  # Create the line plot
  ggplot(data.frame(time = time(time_series), value = time_series), aes(x=time,y=value))  +
    geom_segment(aes(xend = time, yend = 0)) +
    labs(title = paste("Squared returns of", variable, 'in', country),
         x = "Time",
         y = "Squared returns") + 
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5)) +
    scale_y_continuous(limits = c(0, uper))

}

# Plotting the volatility clustering 
plot_volatility_clusters(transformed_italy$stocks, 'Italy', 'Stocks', 150)
```

TODO discribe clusters in financial data (existece, why important and GARCH)

```{r volatility clustering usa stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_usa$stocks, 'USA', 'Stocks', 50)

```

TODO discribe clusters in financial data (existece, why important and GARCH)


<br>

------------------------------------------------------------------------

<br>

# Part 2: Model

------------------------------------------------------------------------

After inspecting the data and evaluating the different tests and plots as well as gathering information about features of the time series the modeling part can be started. The modeling part will be split into multiple parts. Before starting with ARIMA models, the data are split and the trend and sesonality of seasonal data are further inspected using the winter-holt method. After that the ARIMA models are created and evaluated.
First, different ARIMA models are created, based on the insides gathered before, as well as using the auto.arima function. Second, the best model is chosen and the residuals are inspected. If the residuals are not white noise, further models are created. Finally the best model is chosen and the forecasts are created and evaluated.

## 2.2 Trend and Seasonality with winter-holt

```{r stationarity italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}


plot_forecast <- function(train_data, test_data, ts_data, country, variable, alpha, model) {
  model_hw <- ets(train_data, model = model, alpha = alpha)
  ntest <- length(test_data)

  pred <- forecast(model_hw, h = ntest, level = 0)

  pred_hw <- c(model_hw$fitted, pred$mean)

  # Extract the last date of the training data
  last_date_train <- tail(time(train_data), 1)

  ggplot(data.frame(time = time(ts_data), value = ts_data, pred_hw = pred_hw)) + 
    geom_line(aes(x = time, y = value, group = 1)) +
    geom_line(aes(x = time, y = pred_hw, group = 1), color = "dodgerblue4", size = 0.75) +
    geom_vline(aes(xintercept = as.numeric(last_date_train)), color = "darkorange2", size = 0.9) +
    xlab("Year") +
    ylab(paste(variable, "in", country)) +
    labs(title = paste("Forecast for", variable, "in", country),
         subtitle = paste("Exponential Smoothing (ETS) with alpha =", alpha),
         caption = "Vertical line represents the last date of the training data") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 10, hjust = 0.5),
          plot.caption = element_text(size = 6))
  
}

plot_forecast(gdp_italy_train, gdp_italy_test, transformed_italy$gdp, country = "Italy", variable = "GDP", alpha = 0.7, 'AAA')

```

TODO dsicription of the plot, the foreccast only with trend and season is good stron influence in general and little other infromation? No clue what else

```{r stationarity italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot_forecast(cpi_italy_train, cpi_italy_test, transformed_italy$cpi, country = "Italy", variable = "CPI", alpha = 0.7, 'AAA')


```

TODO description of plot and what it means

## 2.3 ARIMA

TO WE NEED THIS REALLY OR DO WE NOT USE IT? QUESTIONHERE3

```{r TODO model automation, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# QUESTION DO WE WANT TO USE THIS? 

create_models <- function(p, d, q, train_data, test_data) {
  results <- data.frame(order = character(),
                         aic = numeric(),
                         bic = numeric(),
                         mpse = numeric())

  for (i in 0:p) {
    for (j in 0:q) {
      order <- c(i, d, j)
      fit <- Arima(train_data, order = order)
      aic <- AIC(fit)
      bic <- BIC(fit)

      pred <- forecast(fit, h = length(test_data))
      mpse <- mean((pred$mean - test_data)^2)

      results <- rbind(results, data.frame(order = paste(order, collapse = "_"),
                                           aic = aic,
                                           bic = bic,
                                           mpse = mpse))
    }
  }

  # Choose parameters for the 3 lowest BIC, 3 lowest AIC, and 3 lowest MPSE
  best_bic <- results[order(results$bic), ][1:3, ]
  best_aic <- results[order(results$aic), ][1:3, ]
  best_mpse <- results[order(results$mpse), ][1:3, ]

  # Extract the selected orders
  selected_orders <- unique(rbind(best_bic, best_aic, best_mpse)$order)

  # Fit models with the selected orders
  selected_models <- lapply(strsplit(selected_orders, "_"), function(x) {
    order <- as.numeric(x)
    fit <- Arima(train_data, order = order)
    return(fit)
  })

  return(selected_models)
}

# Example usage:
selected_models <- create_models(p = 2, d = 1, q = 2, train_data = gdp_italy_train, test_data = gdp_italy_test)

```

### 2.3.1 GDP Italy

```{r modelling italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Function to format ARIMA order
format_arima_order <- function(arma) {
  non_seasonal <- paste(arma[1], arma[6], arma[2])
  seasonal <- paste(arma[3], arma[7], arma[4])
  period <- arma[5]
  return(paste("ARIMA(", non_seasonal, ")", "(", seasonal, ")", "[", period, "]", sep = ""))
}

# Function for model comparison
evaluate_arima_models <- function(models, test_data) {
  
  results <- data.frame(Model = character(), AIC = numeric(), SIC = numeric(), BIC = numeric(), Residuals = character(), MSPE = numeric())
  
  for (model in models) {
    fit <- model
    order <- coef(fit)
    
    # Extract AIC and SIC
    aic <- AIC(fit)
    sic <- AIC(fit, k = log(length(fit$residuals)))
    bic <- BIC(fit)
    
    # Check residuals for white noise
    white_noise <- Box.test(fit$residuals, lag = 20, type = "Ljung-Box")$p.value > 0.05
    residuals_check <- ifelse(white_noise, "White Noise", "Not White Noise")
    
    # Make predictions on test data
    pred <- forecast(fit, h = length(test_data))
    
    # Calculate MSPE
    mspe <- mean(((pred$mean - test_data) / test_data)^2, na.rm = TRUE)*100


    # Append results to the data frame
    name <- format_arima_order(model$arma)
    result_row <- data.frame(Model = name, AIC = aic, SIC = sic, BIC = bic, Residuals = residuals_check, MSPE = mspe)
    results <- rbind(results, result_row)
  }

  return(results)
}


# Crate different models
model_max_i_gdp <- forecast::Arima(gdp_italy_train, order = c(9, 1, 16), method = 'ML')

model_seasonal_i_gdp <- forecast::Arima(gdp_italy_train, order = c(1, 1, 0), seasonal = list(order = c(0, 1, 1), period = 4), method = 'ML')

model_aic_i_gdp <- auto.arima(gdp_italy_train, ic = 'aic')

model_bic_i_gdp <- auto.arima(gdp_italy_train, ic = 'bic')


# Create a list of models
model_list <- list(model_max_i_gdp, model_seasonal_i_gdp, model_aic_i_gdp, model_bic_i_gdp)

# Evaluate the models
evaluate_arima_models(model_list, gdp_italy_test)

```

The ARIMA models we developed correspond to the following characteristics. The first function takes into consideration all the spikes of ACF and PACF and incorporates 9 autoregressive terms and 16 moving average terms, and overall uses the maximum lags. The second model uses seasonality as the main target for the modeling and tells us that it requires differencing for stationarity and for seasonal stationarity. The third uses as the parameter the lowest AIC, in this case, 334.4106, and the fourth model the lowest BIC, which was 341.2077. 


```{r plot residual italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot_residuals_arima <- function(model, country, variable){ 
  
  # Set up the plot
  par(mfrow = c(1, 2), mar = c(3, 4, 4, 1))

  # ACF and PACF plots
  acf(model$residuals, main = paste("ACF of", variable, "residuals in", country))
  pacf(model$residuals, main = paste("PACF of", variable, "residuals in", country))
}


# Plot the best model TODO Yannik maybe in tow seperate parts?
plot_residuals_arima(model_aic_i_gdp, "Italy", "GDP")

```

TODO description and saying best models and no furhter although might be better once (one so small violation okay only95 confidence interval wiht 18 lags 1 or 2 okay)

```{r plot model italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Plot the forecast
plot_forecast_arima <- function(train_data, test_data, ts_data, country, variable, model) {
  ntest <- length(test_data)
  pred <- forecast(model, h = ntest, level = 0)
  pred_arima <- c(model$fitted, pred$mean)
  
  # Extract the last date of the training data
  last_date_train <- tail(time(train_data), 1)
  
  name <- format_arima_order(model$arma)
  
  ggplot(data.frame(time = time(ts_data), value = ts_data, pred_arima = pred_arima)) + 
    geom_line(aes(x = time, y = value, group = 1)) +
    geom_line(aes(x = time, y = pred_arima, group = 1), color = 'darkgreen', size=0.75) +
    geom_vline(aes(xintercept = as.numeric(last_date_train)), color = "darkblue", size = 0.9) +
    xlab("Year") +
    ylab(paste(variable, "in", country)) +
    labs(title = paste("Forecast for", variable, "in", country),
         subtitle = paste("The best model is", name),
         caption = "Vertical line represents the last date of the training data") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 10, hjust = 0.5),
          plot.caption = element_text(size = 6))
}

plot_forecast_arima(gdp_italy_train, gdp_italy_test, transformed_italy$gdp, "Italy", "GDP", model_bic_i_gdp)
```

As observed in the plot, the forecast we achieved with this model is the most accurate one, and it is by using the ARIMA. The predicted or forecasted plot follows with a very small range of difference from the real line, confirming the model's accuracy.

### 2.3.1 CPI Italy

```{r modelling italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# TODO maybe look at seasonal self composed once?

# Creating different models
model_med_i_cpi <- forecast::Arima(cpi_italy_train, order = c(7, 1, 0)) 
model_aic_i_cpi <- auto.arima(cpi_italy_train, ic = 'aic')
model_bic_i_cpi <- auto.arima(cpi_italy_train, ic = 'bic')

model_6_i_cpi <- forecast::Arima(cpi_italy_train, order = c(6, 1, 0))

# Create a list of models
model_list <- list(model_med_i_cpi, model_aic_i_cpi, model_bic_i_cpi)

# Evaluate the models
evaluate_arima_models(model_list, cpi_italy_test)

```

TODO description why which model and evaluation
- first max significant lags 
-Other auto arma with differen IC

```{r plot residual italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the residuals of the best model
plot_residuals_arima(model_bic_i_cpi, "Italy", "CPI")

```

TODO Discribe, there are violations so other model maybe GARCH

```{r squared residuals italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot_squared_residuals <- function(residuals, country, variable, uper = 0) {
  
  # Calculate the squared returns
  squared_residuals <- (residuals)^2
  
  if (uper == 0) {
    uper <- max(squared_residuals) + max(squared_residuals)*0.05
  }

  # Create the line plot
  ggplot(data.frame(time = time(squared_residuals), value = squared_residuals), aes(x=time,y=value))  +
    geom_segment(aes(xend = time, yend = 0)) +
    labs(title = paste("Squared residuals of", variable, 'in', country),
         x = "Time",
         y = "Squared residuals") + 
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5)) +
    scale_y_continuous(limits = c(0, uper))

}

plot_squared_residuals(model_bic_i_cpi$residuals, "Italy", "CPI", 1)

```

TODO Discribe the plot, squared residuals have clusters (?) so GARCH

```{r squared residuals (P)ACF italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}


plot_sqr_residuals_arima <- function(ts, country, variable){ 
  
  # Set up the plot
  par(mfrow = c(1, 2), mar = c(3, 4, 4, 1))

  
  dl_values <- diff(log(ts))
  # ACF and PACF plots
  acf(dl_values, main = paste("ACF of", variable, "squared residuals in", country))
  pacf(dl_values, main = paste("PACF of", variable, "squared residuals in", country))
}



# Plot the best model TODO Yannik maybe in tow seperate parts?
plot_sqr_residuals_arima(transformed_italy$cpi , "Italy", "GDP")

```
ACF violations at lag values 2 and 4 suggest a GARCH(2) component.
PACF violations at lag values 2, 4, 6, and 12 suggest a GARCH(2) component.
QUESTION HOW THE FUCK DO I DO THIS?

```{r garch italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
evaluate_garch_models <- function(models) {
  
  results <- data.frame(Model = character(), AIC = numeric(), BIC = numeric(), Residuals = character())
  
  for (i in seq_along(models)) {
    
    model <- models[[i]]
    
    garch_info <- infocriteria(model)
    
    # Extract AIC and SIC
    aic <-  garch_info[1]
    bic <-  garch_info[2]
    
    # Check residuals for white noise
    white_noise <- Box.test(residuals(model), lag = 20, type = "Ljung-Box")$p.value > 0.05
    residuals_check <- ifelse(white_noise, "White Noise", "Not White Noise")

    # Append results to the data frame
    name <- paste("Model", i)
    result_row <- data.frame(Model = name, AIC = aic, BIC = bic, Residuals = residuals_check)
    results <- rbind(results, result_row)
  }
  
  return(results)
}

# Example usage with a single GARCH model
a5 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(5, 0)), distribution.model = "std"), data = cpi_italy_train)
a6 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(6, 0)), distribution.model = "std"), data = cpi_italy_train)
a7 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(7, 0)), distribution.model = "std"), data = cpi_italy_train)
a8 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(8, 0)), distribution.model = "std"), data = cpi_italy_train)
a9 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(9, 0)), distribution.model = "std"), data = cpi_italy_train)
g1 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), distribution.model = "std"), data = cpi_italy_train)
g2 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(2, 2)), distribution.model = "std"), data = cpi_italy_train)
g3 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(3, 3)), distribution.model = "std"), data = cpi_italy_train)
g4 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(4, 4)), distribution.model = "std"), data = cpi_italy_train)
g5 <- ugarchfit(ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(5, 5)), distribution.model = "std"), data = cpi_italy_train)

model_list_garch <- list(a5, a6, a7, a8, a9, g1, g2, g3, g4, g5)

evaluate_garch_models(model_list_garch)

```

TODO Discribe, mntion combination possible but nto done


```{r plot modelling italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the forecast
plot_forecast_garch <- function(train_data, test_data, ts_data, country, variable, model) {
  ntest <- length(test_data)
  forecast_values <- ugarchforecast(model, n.ahead = length(test_data))
  forecast_series <- forecast_values@forecast$seriesFor
  
  pred_garch <- c(model@fit$fitted.values, forecast_series)

  # Extract the last date of the training data
  last_date_train <- tail(time(train_data), 1)
  
  ggplot(data.frame(time = time(ts_data), value = ts_data, pred_arima = pred_garch)) + 
    geom_line(aes(x = time, y = value, group = 1)) +
    geom_line(aes(x = time, y = pred_garch, group = 1), color = 'darkgreen', size=0.75) +
    geom_vline(aes(xintercept = as.numeric(last_date_train)), color = "darkblue", size = 0.9) +
    xlab("Year") +
    ylab(paste(variable, "in", country)) +
    labs(title = paste("Forecast for", variable, "in", country),
         caption = "Vertical line represents the last date of the training data") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 10, hjust = 0.5),
          plot.caption = element_text(size = 6))
}


plot_forecast_garch(cpi_italy_train, cpi_italy_test, transformed_italy$cpi, "Italy", "CPI", a7)

```

QUESTOION Why does it not work?


```{r plot modelling italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(rugarch)
library(forecast)
library(ggplot2)

# Function to plot GARCH forecast
plot_forecast_garch <- function(train_data, test_data, ts_data, country, variable, model) {
  ntest <- length(test_data)
  
  
  
  
  # Forecast the conditional variance using the fitted GARCH model
  vola_fit <- ts(garch11@fit$sigma^2,end=c(2019,10),frequency = 12)
  vola_forecast <- ts(garch11@forecast$seriesFor,end=c(2020,10),frequency = 12)
  
  pred <- ugarchforecast(model, n.ahead = ntest)
  pred_garch <- as.numeric(sigma(pred))
  
  # Extract the last date of the training data
  last_date_train <- tail(time(train_data), 1)
  
  ggplot(data.frame(time = time(ts_data), value = ts_data, pred_garch = pred_garch)) + 
    #geom_line(aes(x = time, y = value, group = 1)) +
    geom_line(aes(x = time, y = pred_garch, group = 1), color = 'darkred', size = 0.75) +
    geom_vline(aes(xintercept = as.numeric(last_date_train)), color = "darkblue", size = 0.9) +
    xlab("Year") +
    ylab(paste(variable, "in", country)) +
    labs(title = paste("Forecast for", variable, "in", country),
         subtitle = paste("The best GARCH model"),
         caption = "Vertical line represents the last date of the training data") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 10, hjust = 0.5),
          plot.caption = element_text(size = 6))
}

# Example usage
plot_forecast_garch(cpi_italy_train, cpi_italy_test, transformed_italy$cpi, "YourCountry", "YourVariable", g2)



```

### 2.3.1 Stocks Italy

```{r modelling italy stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# TODO maybe directly GARCH Yannik

# Creating different models
model_min_i_stocks <- forecast::Arima(stocks_italy_train, order = c(2, 1, 0)) 
model_aic_i_stocks <- auto.arima(stocks_italy_train, ic = 'aic')
model_bic_i_stocks <- auto.arima(stocks_italy_train, ic = 'bic')

# Create a list of models
model_list <- list(model_min_i_stocks, model_aic_i_stocks, model_bic_i_stocks)

# Evaluate the models
evaluate_arima_models(model_list, stocks_italy_test)

```

### 2.3.1 GDP USA

```{r modelling usa gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Creating different models
model_min_u_gdp <- forecast::Arima(gdp_usa_train, order = c(1, 1, 0))
model_drift_u_gdp <- forecast::Arima(gdp_usa_train, order = c(1, 1, 0), include.drift = TRUE)
model_aic_u_gdp <- auto.arima(gdp_usa_train, ic = 'aic')
model_bic_u_gdp <- auto.arima(gdp_usa_train, ic = 'bic')

# Create a list of models
model_list <- list(model_min_u_gdp, model_drift_u_gdp, model_aic_u_gdp, model_bic_u_gdp)

# Evaluate the models
evaluate_arima_models(model_list, gdp_usa_test)
```

TODO explain why models - Spikes - Drift because one more diff needed then said to get stationary so maybe - IC used

```{r plot residual usa gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the residuals of the best model
plot_residuals_arima(model_aic_u_gdp, "USA", "GDP")

```

TODO Describe no violations

```{r plot model usa gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot_forecast_arima(gdp_usa_train, gdp_usa_test, transformed_usa$gdp, "USA", "GDP", model_aic_u_gdp)

# TODO can we improve it?

```

TODO Describe forcast and why underestimated ?, not bad model since no residuals violations (best we could do)

### 2.3.1 CPI USA

```{r modelling usa cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Creating different models
model_min_u_cpi <- forecast::Arima(cpi_usa_train, order = c(1, 1, 0))

model_aic_u_cpi <- auto.arima(cpi_usa_train, ic = 'aic')
model_bic_u_cpi <- auto.arima(cpi_usa_train, ic = 'bic')

# Create a list of models
model_list <- list(model_min_u_cpi, model_aic_u_cpi, model_bic_u_cpi, model_drift_u_cpi)

# Evaluate the models
evaluate_arima_models(model_list, cpi_usa_test)


```

TODO discribe why models

```{r plot residual usa cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the best model TODO Yannik maybe in tow seperate parts?
plot_residuals_arima(model_min_u_cpi, "USA", "CPI")

```

```{r garch model usa cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Trying other models (GARCH?)
```

### 2.3.1 Stocks USA

```{r modelling usa stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Maybe directly GARCH?

# Creating different models
model_min_u_stocks <- forecast::Arima(stocks_usa_train, order = c(1, 1, 0))
model_max_u_stocks <- forecast::Arima(stocks_usa_train, order = c(6, 1, 0))
model_aic_u_stocks <- auto.arima(stocks_usa_train, ic = 'aic')
model_bic_u_stocks <- auto.arima(stocks_usa_train, ic = 'bic')

# Create a list of models
model_list <- list(model_min_u_stocks, model_max_u_stocks, model_aic_u_stocks, model_bic_u_stocks)

# Evaluate the models
evaluate_arima_models(model_list, stocks_usa_test)

```

```{r plot residual usa stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the best model TODO Yannik maybe in tow seperate parts?
#plot_residuals_arima(, "USA", "Stocks")

```
