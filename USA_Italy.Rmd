---
title: "Advanced Data Analytics"
author:
  - Loukas Gonzalez
  - Simon Alvarez Bliffeld
  - Simon Gonzalez
  - Yannik Biebert
date: "2023-11-28"
output:      
  rmarkdown::html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
# Set up: do not change!!!
knitr::opts_chunk$set(echo = TRUE)
```

<br>

------------------------------------------------------------------------

<br>

# Part 1: Prepare and inspect the data

Steps for us:

-   Visual inspection of data and season, trend DONE

-   Stationarity testing DONE

-   Inspect autocorrelation with acf and pacf DONE

-   Inspect volatility clustering (if so, maybe GARCH needed?)

-   if it has season use holt-winters, DO WE NEED TBATS or STLM? Because I dont think whe have two cicles in each other

-   Maybe new autocorrelation with acf and pacf for the estimated seasonality and trend (if we use the holt winter model to mode arima)

-   Look for ARIMA models (on data and on estimated ets()/msts()

-   Identify the seasonal model by analyzing the seasonal coefficients of the ACF and PACF

-   Identify the regular component by exploring the ACF and PACF of the residuals of the seasonal model.

-   Compare models (including ets models)- AIC or Accuracy Metrics

-   Choose best model and visualize, look at residuals, maybe GARCH (or should be aready dicide this before using ARIMA Model and use it directly?)

-   Use maybe Garch, and compare those models

-   Summary of findings

-   Forcast and plot final model

-   conclusion of forecast

------------------------------------------------------------------------

## 1.1 Importing and inspecting the data set

```{r Import data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# import packages
library(pacman)
p_load(
  readxl, tseries, tidyverse, dplyr, tidyr, forecast, fpp2, stats, quantmod, zoo, lubridate, ggplot2, cowplot
)

# import data set xlxs
data <- read_excel("Datasets.xlsx")

# removing not used columns Housing and Unemployment
data <- data[, -c(7, 9)]


# Display the data set
print(data)

```

TODO Description

## 1.2 Prepare the data

```{r transform data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Split the data into two dataframes based on the country
data_italy <- subset(data, Country %in% c("Italy"))
data_usa <- subset(data, Country %in% c("USA"))

# Function for data transformation
transform_data <- function(df) {
  # Extract columns from the dataframe
  gdp <- df$'GDP, billion currency units'
  cpi <- df$'Consumer Price Index (CPI)'
  stocks <- df$'Stock market index'

  # Drop missing values (becuase only every quarter)
  gdp <- na.omit(gdp)

  # Drop missing values (becuase last in the month)
  cpi <- na.omit(cpi)
  stocks <- na.omit(stocks)

  # Change to time series
  gdp <- ts(gdp, start = c(2000, 1), frequency = 4)
  cpi <- ts(cpi, start = c(2000, 1), frequency = 12)
  stocks <- ts(stocks, start = c(2000, 1), frequency = 12)
  
  # Return the time series as separate variables
  return(list(gdp = gdp, cpi = cpi, stocks = stocks))
}

# Apply the transformation function
transformed_italy  <- transform_data(data_italy)
transformed_usa <- transform_data(data_usa)

```

TODO Description

## 1.3 Visual inspection of the data, including Seasonality

QUESTIONHERE1:

```{r plot gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Create a function for visualization.
plot_and_zoom <- function(data, variable, country,num_years) {
  
  # Extract the specified number of years from the time series
  end_date <- start(data) + c(num_years, 0)
  window_data <- window(data, start = start(data), end = end_date)
  
  # Create the main plot
  main_plot <- ggplot(data, aes(x = time(data), y = as.numeric(data))) +
    geom_line() +
    theme_minimal() +
    labs(title = paste0(variable, ' in ', country), x = "Year", y = variable) +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5))
  
  # Create a zoomed-in version with the specified number of years
  zoomed_in_plot <- ggplot(window_data, aes(x = time(window_data), y = as.numeric(window_data))) +
    geom_line() +
    labs(title = paste0('Zoomed in ',variable, ' in ', country), x = "Year", y = variable) +
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5))
  
  plot_grid(main_plot, zoomed_in_plot, ncol = 1)
  
}

# Plot the GDP for Italy
plot_and_zoom(transformed_italy$gdp, 'GDP', 'Italy', 4)

```

Looking at the graph of Italy's GDP from the last 23 years, we can make some observations. The GDP shows a clear upward trend, with a sharper increase from 2000 to 2008, where it stabilizes, and again an increase from 2015-2023, with a sharp dip in 2020. The two interruptions in the trend correspond to the 2008 financial crisis and the 2020 Coronavirus Pandemic, which shook the economy and its growth. We can also note a seasonality throughout the time series. Italy's economy after 2001 began to slow down, even though the GDP is seen to be growing, the rate of growth had decreased. Factors such as "aging population, inflation, stagnation, and the impact of globalization on trade and demand" affected heavily the country's development and economic growth (Ardeni & Gallegati, 2023). Italy's development is slow mainly when compared to other countries European countries with similar capabilities and factors. In the zoomed version of Italy's GDP, we can observe another factor. The plot shows a clear trend or pattern of seasonality, where in the first part of the year we observe a slight increase in the GDP, followed by a sharper increase in the second part of the year, and this is observed in all of the years included.

```{r plot cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the CPI for Italy
plot_and_zoom(transformed_italy$cpi, 'CPI', 'Italy', 4)


```

TODO Description

```{r plot stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot stocks for Italy
plot_and_zoom(transformed_italy$stocks, 'Stocks', 'Italy', 4)

```

TODO Description

```{r plot gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot GDP for USA
plot_and_zoom(transformed_usa$gdp, 'GDP', 'USA', 4)

```

TODO Description

```{r plot cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot CPI for USA
plot_and_zoom(transformed_usa$cpi, 'CPI', 'USA', 4)

```

TODO Description

```{r plot stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot stocks for USA
plot_and_zoom(transformed_usa$stocks, 'Stocks', 'USA', 4)

```

TODO Describe

## 1.4 Evaluate the data from Italy

```{r evaluate gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Analyse the different variables for stationarity
analyze_time_series <- function(ts_data, country, variable) {

  # Doing the ADF and PP test, as well as determining diff
  adf_result <- adf.test(ts_data)
  pp_result <- pp.test(ts_data)
  num_diffs <- ndiffs(ts_data)

  # Print results for the current variable
  cat("Results for", variable, "in", country, ":\n")
  cat("ADF Test:\n")
  cat("  P-Value:", adf_result$p.value, "\n")
  cat("PP Test:\n")
  cat("  P-Value:", pp_result$p.value, "\n")
  cat("Number of Differences Required for Stationarity:", num_diffs, "\n\n")
  
  # Set up the plot
  par(mfrow = c(1, 2), mar = c(3, 4, 4, 1))

  # ACF and PACF plots
  acf(ts_data, main = paste("ACF of", variable, "in", country))
  pacf(ts_data, main = paste("PACF of", variable, "in", country))
}

# Explore gdp of Italy
analyze_time_series(transformed_italy$gdp, "Italy", 'GDP')

```

TODO Description

```{r differenced gdp in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Analyse the differenced variables for stationary
analyze_diff_series <- function(ts_data, country, variable) {
  
  # Getting number of differences required for stationarity
  num_diffs <- ndiffs(ts_data)
  
  # Differncing num_diffs times
  for (i in 1:num_diffs) {
    ts_data <- diff(ts_data)
  }
  
  # Performing the ADF and PP test
  adf_result <- adf.test(ts_data)
  pp_result <- pp.test(ts_data)
  num_diffs_new <- ndiffs(ts_data)
  
  # Print results for the current variable
  cat("Results for", variable, "in", country, ":\n")
  cat("ADF Test:\n")
  cat("  P-Value:", adf_result$p.value, "\n")
  cat("PP Test:\n")
  cat("  P-Value:", pp_result$p.value, "\n")
  cat("Number of Differences Required for Stationarity:", num_diffs_new, "\n\n")

}

# Difference data from Italy
analyze_diff_series(transformed_italy$gdp, "Italy", 'GDP')

```

TODO Description

```{r evaluate cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore cpi of Italy
analyze_time_series(transformed_italy$cpi, "Italy", 'CPI')

```

TODO Description

```{r differenced cpi in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore cpi of Italy
analyze_diff_series(transformed_italy$cpi, "Italy", 'CPI')

```

TODO Description

```{r evaluate stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore stocks of Italy
analyze_time_series(transformed_italy$stocks, "Italy", 'Stocks')


```

TODO Description

```{r differenced stocks in italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore stocks of Italy
analyze_diff_series(transformed_italy$stocks, "Italy", 'Stocks')

```

TODO Description

## 1.4 Evaluate the data from USA

```{r evaluate gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore gdp of USA
analyze_time_series(transformed_usa$gdp, "USA", 'GDP')

```

TODO Description

```{r differenced gdp in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore gdp of Italy
analyze_diff_series(transformed_usa$gdp, "USA", 'GDP')

```

TODO Description

```{r evaluate cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore cpi of USA
analyze_time_series(transformed_usa$cpi, "USA", 'CPI')

```

TODO Description

```{r differenced cpi in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore cpi of Italy
analyze_diff_series(transformed_usa$cpi, "USA", 'CPI')

```

TODO Description

```{r evaluate stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Explore stocks of USA
analyze_time_series(transformed_usa$stocks, "USA", 'Stocks')

```

TODO Description

```{r differenced stocks in usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore stocks of Italy
analyze_diff_series(transformed_usa$stocks, "USA", 'Stocks')

```

TODO Description

## 1.5 Volatility clustering

TODO? Is that it?

```{r volatility clustering italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

plot_volatility_clusters <- function(time_series, variable, country,width = 4) {
  
  # Calculate the rolling standard deviation
  rolling_sd <- zoo::rollapply(time_series, FUN = sd, align = "center", width = width)

  # Assuming rolling_sd is already calculated
  rolling_sd_data <- data.frame(Time = time(rolling_sd), RollingSD = coredata(rolling_sd))
  
  # Create the line plot
  ggplot(data = rolling_sd_data, aes(x = Time, y = RollingSD)) +
    geom_line() +
    labs(title = paste("Rolling Standard Deviation of", variable, 'in', country),
         x = "Time",
         y = "Rolling Standard Deviation") + 
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5))
    
}

# Plotting the volatility clustering 
plot_volatility_clusters(transformed_italy$stocks, 'Italy', 'GDP', 8) # TODO which width?


```

TODO Descripiton

```{r volatility clustering italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_italy$cpi, 'Italy', 'CPI', 8)

```

TODO Descripiton

```{r volatility clustering italy stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_italy$stocks, 'Italy', 'Stocks', 8)

```

TODO Descripiton

```{r volatility clustering usa gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_usa$gdp, 'USA','GDP', 8)


```

TODO Descripiton

```{r volatility clustering usa cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_usa$cpi, 'USA', 'CPI', 8)

```

TODO Descripiton

```{r volatility clustering usa stocks, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=3}

# Plotting the volatility clustering
plot_volatility_clusters(transformed_usa$stocks, 'USA', 'Stocks', 8)

```

TODO Descripiton

<br>

------------------------------------------------------------------------

<br>

# Part 2: Model

------------------------------------------------------------------------

## 2.1 Train test split

QUESTIONHERE2:

```{r train test split, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Creang train test split function
train_test_split <- function(data_list, train_percentage = 0.8) {
  split_data <- list()
  
  # Loop through the variables in the list
  for (variable in names(data_list)) {
    ts_data <- data_list[[variable]]
    data_length <- length(ts_data)

    # Calculate the train size
    train_size <- round(train_percentage * data_length)

    # Split the data
    train_data <- ts_data[1:train_size]
    test_data <- ts_data[(train_size + 1):data_length]
    
    # Add the data to the list
    split_data[[paste0(variable, "_train")]] <- train_data
    split_data[[paste0(variable, "_test")]] <- test_data
  }

  return(split_data)
}

# Apply the train test split function
split_italy <- train_test_split(transformed_italy)
split_usa <- train_test_split(transformed_usa)

print(is.ts(split_italy$gdp_train)) # TODO IS NOT A TS ANYMORE SHE DID NOT CARE EITHER?
print(split_italy$gdp_train) 


```

Had for some reason huge troubles with it sting in ts so needed to create this

```{r train test split alternative, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# TODO Do we want to use this or the one above?

# Function for train test split
train_test_split <- function(data_list, train_percentage = 0.8) {
  split_data <- list()
  
  # Loop through the variables in the list
  for (variable in names(data_list)) {
    ts_data <- data_list[[variable]]
    data_length <- length(ts_data)

    # Calculate the train size
    train_size <- round(train_percentage * data_length)
    
    # Train split, this way needed, to keep the ts format
    train_data <- ts(ts_data[1:train_size], start = start(ts_data), frequency = frequency(ts_data))

    end_time <- time(train_data)[length(train_data)]
    
    # Get start for testdata, if only split with [:] the ts type is lost as well as the start time
    if (frequency(ts_data) == 12) {
      end_time <- end_time + 1/12
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 12 + 1
    } else if (frequency(ts_data) == 4) {
      end_time <- end_time + 1/4
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 4 + 1
    } else {
      print('Error: Frequency not supported')
    }

    test_data <- ts(ts_data[(train_size + 1):data_length], start = c(start_year, start_month), frequency = frequency(ts_data))
    
    # Add the data to the list
    split_data[[paste0(variable, "_train")]] <- train_data
    split_data[[paste0(variable, "_test")]] <- test_data
  }

  return(split_data)
}

# Apply the train test split function
split_italy <- train_test_split(transformed_italy)
split_usa <- train_test_split(transformed_usa)

```

```{r extract data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Italy variables
gdp_italy_train <- split_italy$gdp_train
gdp_italy_test <- split_italy$gdp_test

cpi_italy_train <- split_italy$cpi_train
cpi_italy_test <- split_italy$cpi_test

stocks_italy_train <- split_italy$stocks_train
stocks_italy_test <- split_italy$stocks_test

# USA variables
gdp_usa_train <- split_usa$gdp_train
gdp_usa_test <- split_usa$gdp_test

cpi_usa_train <- split_usa$cpi_train
cpi_usa_test <- split_usa$cpi_test

stocks_usa_train <- split_usa$stocks_train
stocks_usa_test <- split_usa$stocks_test

```

## 2.2 Trend and Seasonality with holt???

Only for Italy gdp and cpi, or should we put this after the visual inspection? TODO

QUESTIONHERE1:

```{r stationarity italy cpi, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}


plot_forecast <- function(train_data, test_data, ts_data, country, variable, alpha, model) {
  model_hw <- ets(train_data, model = model, alpha = alpha)
  ntest <- length(test_data)

  pred <- forecast(model_hw, h = ntest, level = 0)

  pred_hw <- c(model_hw$fitted, pred$mean)

  # Extract the last date of the training data
  last_date_train <- tail(time(train_data), 1)

  ggplot(data.frame(time = time(ts_data), value = ts_data, pred_hw = pred_hw)) + 
    geom_line(aes(x = time, y = value, group = 1)) +
    geom_line(aes(x = time, y = pred_hw, group = 1), color = "dodgerblue4", size = 1.5) +
    geom_vline(aes(xintercept = as.numeric(last_date_train)), color = "darkorange2", size = 0.9) +
    xlab("Year") +
    ylab(paste(variable, "in", country)) +
    labs(title = paste("Forecast for", variable, "in", country),
         subtitle = paste("Exponential Smoothing (ETS) with alpha =", alpha),
         caption = "Vertical line represents the last date of the training data") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 10, hjust = 0.5),
          plot.caption = element_text(size = 6))
  
}

plot_forecast(gdp_italy_train, gdp_italy_test, transformed_italy$gdp, country = "Italy", variable = "GDP", alpha = 0.7, 'AAA')

```

```{r stationarity italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot_forecast(cpi_italy_train, cpi_italy_test, transformed_italy$cpi, country = "Italy", variable = "CPI", alpha = 0.7, 'AAA')


```

## 2.3 ARIMA

### 2.3.1 GDP Italy

```{r modelling italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Function for model creation

ntest <- length(gdp_italy_test)

# TODO in text : ACF slow decay, PACF sharp, probably AR 
# 16 MA
# Diff 1
# 9 AR


# Function for model comparison


model_max <- Arima(gdp_italy_train, order = c(9, 1, 16), method = "ML")
model_aic <- auto.arima(gdp_italy_train, ic = 'aic')
model_bic <- auto.arima(gdp_italy_train, ic = 'bic')

predict_max <- forecast::forecast(model_max, h = ntest, level = 0)
predict_aic <- forecast::forecast(model_aic, h = ntest, level = 0)
predict_bic <- forecast::forecast(model_bic, h = ntest, level = 0)

# Get the AIC 

################## HAVE TO WORK WITH cat()

model_max$aic
model_aic$aic
model_bic$aic

print(' ')

accuracy(predict_max, gdp_italy_test)
accuracy(predict_aic, gdp_italy_test)
accuracy(predict_bic, gdp_italy_test)

# Two best:
model_aic # WHAT IS SMA1?
model_bic


# Box.test(auto_model_adjusted_bic$residuals) # p-value = 0.01 --> Residuals NOT white noise
                                            # Big p is only white noise


```
### 2.3.1 GDP Italy


### 2.3.1 CPI Italy

### 2.3.1 Stocks Italy

### 2.3.1 GDP USA

### 2.3.1 CPI USA

### 2.3.1 Stocks USA
```{r}

### plot the forecasts

# elp$pred <- c(model$fitted, pred$mean)

# ggplot(elp)+ 
#   geom_line(aes(mdy(DATE), Value, group = 1))+
#   geom_line(aes(mdy(DATE), pred, group = 1), color = "dodgerblue4")+
#   geom_vline(aes(xintercept=mdy("02-01-2016")), color = "darkorange2", size = 0.9)+
#   xlab("Date")+
#   ylab("Electric production")

### zoom into the test set

# ggplot(elp[374:397,])+
#   geom_line(aes(mdy(DATE), Value, group = 1))+
#   geom_line(aes(mdy(DATE), pred, group = 1), color = "dodgerblue4")+
#   xlab("Date")+
#   ylab("Electric production")


```
