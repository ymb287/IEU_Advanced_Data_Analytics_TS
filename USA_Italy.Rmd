---
title: "Advanced Data Analytics"
author:
  - Loukas Gonzalez
  - Simon Alvarez Bliffeld
  - Simon Gonzalez
  - Yannik Biebert
date: "2023-11-28"
output:      
  rmarkdown::html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
# Set up: do not change!!!
knitr::opts_chunk$set(echo = TRUE)
```

<br>

------------------------------------------------------------------------

<br>

# Part 1: Prepare and inspect the data

------------------------------------------------------------------------

## 1.1 Importing and inspecting the data set

```{r Import data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# import packages
library(pacman)
p_load(
  readxl, tseries, tidyverse, dplyr, tidyr, forecast, fpp2, stats, quantmod
)

# import data set xlxs
data <- read_excel("Datasets.xlsx")

# Display the data
print(data)

```

## 1.2 Prepare the data

```{r transform data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Split the data into two dataframes based on the country
data_italy <- subset(data, Country %in% c("Italy"))
data_usa <- subset(data, Country %in% c("USA"))

# Function for data transformation
transform_data <- function(df) {
  # Extract columns from the dataframe
  gdp <- df$'GDP, billion currency units'
  housing_index <- df$'House price index'
  cpi <- df$'Consumer Price Index (CPI)'
  unemployment <- df$'Unemployment rate, percent'
  stocks <- df$'Stock market index'

  # Drop missing values (becuase only every quarter)
  gdp <- na.omit(gdp)
  housing_index <- na.omit(housing_index)
  
  # Drop missing values (becuase last in the month)
  cpi <- na.omit(cpi)
  unemployment <- na.omit(unemployment)
  stocks <- na.omit(stocks)

  # Change to time series
  gdp <- ts(gdp, start = c(2000, 1), frequency = 4)
  housing_index <- ts(housing_index, start = c(2000, 1), frequency = 4)
  cpi <- ts(cpi, start = c(2000, 1), frequency = 12)
  unemployment <- ts(unemployment, start = c(2000, 1), frequency = 12)
  stocks <- ts(stocks, start = c(2000, 1), frequency = 12)
  
  # Return the time series as separate variables
  return(list(gdp = gdp, housing_index = housing_index, cpi = cpi, unemployment = unemployment, stocks = stocks))
}

# Apply the transformation function
transformed_italy  <- transform_data(data_italy)
transformed_usa <- transform_data(data_usa)

```

```{r plot the data italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the Italy data
plot(transformed_italy$gdp, main = "GDP in Italy"
     , xlab = "Year", ylab = "GDP")
plot(transformed_italy$housing_index, main = "Housing Index in Italy"
     , xlab = "Year", ylab = "Housing Index")
plot(transformed_italy$cpi, main = "CPI in Italy"
     , xlab = "Year", ylab = "CPI")
plot(transformed_italy$unemployment, main = "Unemployment in Italy"
     , xlab = "Year", ylab = "Unemployment")
plot(transformed_italy$stocks, main = "Stocks in Italy"
     , xlab = "Year", ylab = "Stocks")

```

```{r plot the data usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Plot the USA data
plot(transformed_usa$gdp, main = "GDP in USA"
     , xlab = "Year", ylab = "GDP")
plot(transformed_usa$housing_index, main = "Housing Index in USA"
     , xlab = "Year", ylab = "Housing Index")
plot(transformed_usa$cpi, main = "CPI in USA"
     , xlab = "Year", ylab = "CPI")
plot(transformed_usa$unemployment, main = "Unemployment in USA"
     , xlab = "Year", ylab = "Unemployment")
plot(transformed_usa$stocks, main = "Stocks in USA"
     , xlab = "Year", ylab = "Stocks")

```

TODO Looking into seasonality

## 1.3 Evaluate the data from Italy

```{r evaluate data italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Analyse the different variables for stationarity
analyze_time_series <- function(ts_data, country) {
  # Set up the plot
  par(mfrow = c(2, 2))

  # Loop through the variables in the list
  for (i in seq_along(names(ts_data))) {
    variable <- names(ts_data)[i]
    
    # Doing the ADF and PP test, as well as determining diff
    adf_result <- adf.test(ts_data[[variable]])
    pp_result <- pp.test(ts_data[[variable]])
    num_diffs <- ndiffs(ts_data[[variable]])

    # Print results for the current variable
    cat("Results for", variable, "in", country, ":\n")
    cat("ADF Test:\n")
    cat("  P-Value:", adf_result$p.value, "\n")
    cat("PP Test:\n")
    cat("  P-Value:", pp_result$p.value, "\n")
    cat("Number of Differences Required for Stationarity:", num_diffs, "\n\n")

    # ACF and PACF plots
    acf(ts_data[[variable]], main = paste("ACF of", variable, "in", country))
    pacf(ts_data[[variable]], main = paste("PACF of", variable, "in", country))
    
    # If we have processed the first two variables, reset layout for the next row
    if (i == 2) {
      par(mfrow = c(2, 2))
    }
  }
}

# Explore data of Italy
analyze_time_series(transformed_italy, "Italy")

```

Non of the variables is stationary. We will have to difference them.

```{r evaluate differenced italy, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Analyse the differenced variables for stationary
analyze_diff_series <- function(ts_data, country) {
  # Loop through the variables in the list
  for (variable in names(ts_data)) {
    # Getting number of differences required for stationarity
    ts <- ts_data[[variable]]
    num_diffs <- ndiffs(ts)
    
    # Differncing num_diffs times
    for (i in 1:num_diffs) {
      ts <- diff(ts)
    }
    
    # Performing the ADF and PP test
    adf_result <- adf.test(ts)
    pp_result <- pp.test(ts)
    num_diffs_new <- ndiffs(ts)
    
    # Print results for the current variable
    cat("Results for", variable, "in", country, ":\n")
    cat("ADF Test:\n")
    cat("  P-Value:", adf_result$p.value, "\n")
    cat("PP Test:\n")
    cat("  P-Value:", pp_result$p.value, "\n")
    cat("Number of Differences Required for Stationarity:", num_diffs_new, "\n\n")
  }
}

# Difference data from Italy
analyze_diff_series(transformed_italy, "Italy")

```

## 1.4 Evaluate the data from the USA

```{r evaluate data usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Explore data of USA
analyze_time_series(transformed_italy, "USA")

```


```{r evaluate differenced usa, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Difference data from USA
analyze_diff_series(transformed_italy, "Italy")

```


## 1.5 Train test split

```{r train test split, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Creang train test split function
train_test_split <- function(data_list, train_percentage = 0.8) {
  split_data <- list()
  
  # Loop through the variables in the list
  for (variable in names(data_list)) {
    ts_data <- data_list[[variable]]
    data_length <- length(ts_data)

    # Calculate the train size
    train_size <- round(train_percentage * data_length)

    # Split the data
    train_data <- ts_data[1:train_size]
    test_data <- ts_data[(train_size + 1):data_length]
    
    # Add the data to the list
    split_data[[paste0(variable, "_train")]] <- train_data
    split_data[[paste0(variable, "_test")]] <- test_data
  }

  return(split_data)
}

# Apply the train test split function
split_italy <- train_test_split(transformed_italy)
split_usa <- train_test_split(transformed_usa)

print(split_italy$gdp_train) # TODO IS NOT A TS ANYMORE SHE DID NOT CARE EITHER?

```

Had for some reason huge troubles wiht it sting in ts so needed to creat this shit

```{r train test split alternative, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# TODO Do we want to use this or the one above?

# Function for train test split
train_test_split <- function(data_list, train_percentage = 0.8) {
  split_data <- list()
  
  # Loop through the variables in the list
  for (variable in names(data_list)) {
    ts_data <- data_list[[variable]]
    data_length <- length(ts_data)

    # Calculate the train size
    train_size <- round(train_percentage * data_length)
    
    # Train split, this way needed, to keep the ts format
    train_data <- ts(ts_data[1:train_size], start = start(ts_data), frequency = frequency(ts_data))

    end_time <- time(train_data)[length(train_data)]
    
    # Get start for testdata, if only split with [:] the ts type is lost as well as the start time
    if (frequency(ts_data) == 12) {
      end_time <- end_time + 1/12
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 12 + 1
    } else if (frequency(ts_data) == 4) {
      end_time <- end_time + 1/4
      start_year <- floor(end_time)
      start_month <- (end_time - start_year) * 4 + 1
    } else {
      print('Error: Frequency not supported')
    }

    test_data <- ts(ts_data[(train_size + 1):data_length], start = c(start_year, start_month), frequency = frequency(ts_data))
    
    # Add the data to the list
    split_data[[paste0(variable, "_train")]] <- train_data
    split_data[[paste0(variable, "_test")]] <- test_data
  }

  return(split_data)
}

# Apply the train test split function
split_italy <- train_test_split(transformed_italy)
split_usa <- train_test_split(transformed_usa)

```



```{r extract data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Italy variables
gdp_italy_train <- split_italy$gdp_train
gdp_italy_test <- split_italy$gdp_test

housing_index_italy_train <- split_italy$housing_index_train
housing_index_italy_test <- split_italy$housing_index_test

cpi_italy_train <- split_italy$cpi_train
cpi_italy_test <- split_italy$cpi_test

unemployment_italy_train <- split_italy$unemployment_train
unemployment_italy_test <- split_italy$unemployment_test

stocks_italy_train <- split_italy$stocks_train
stocks_italy_test <- split_italy$stocks_test

# USA variables
gdp_usa_train <- split_usa$gdp_train
gdp_usa_test <- split_usa$gdp_test

housing_index_usa_train <- split_usa$housing_index_train
housing_index_usa_test <- split_usa$housing_index_test

cpi_usa_train <- split_usa$cpi_train
cpi_usa_test <- split_usa$cpi_test

unemployment_usa_train <- split_usa$unemployment_train
unemployment_usa_test <- split_usa$unemployment_test

stocks_usa_train <- split_usa$stocks_train
stocks_usa_test <- split_usa$stocks_test

```


<br>

------------------------------------------------------------------------

<br>

# Part 2: Model Itally


------------------------------------------------------------------------

<br>

## 2 GDP

```{r modelling italy gdp, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Function for model creation
gdp_italy_train
gdp_italy_test


```
